- name: Creating instance and route 53 records
  hosts: local
  connection: local
  vars:
   ami_id: ami-0220d79f3f480ecf5
   envmt: dev
   scg_id: sg-04a1d138ef8dc04ed
   domine_name: sivadevops707.online
   action: create
   instances:
   - mongodb
   - catalogue

  tasks:
  - name: start an instance with a public IP address
    amazon.aws.ec2_instance:
     instance_type: t3.micro
     security_group: "{{ scg_id }}"
     image_id: "{{ ami_id }}"
     name: "{{ item }}-{{ envmt }}"
     tags:
      project: Roboshop
      component: "{{ item }}"
      environment: "{{ envmt }}"
      name: "{{ envmt }}-{{ envmt }}"
    loop: "{{ instances }}"
    register: ec2_output 


  - name: print ec2_output
    ansible.builtin.debug:
     msg: "{{ ec2_output }}"  

  - name: create route 53 records
    amazon.aws.route53:
     state: present
     zone: "{{ domine_name }}"
     record: "{{ item.item }}-{{ envmt }}.{{ domine_name }}"  #mongodb-dev.sivadevops707.online
     type: A
     ttl: 1
     value: "{{ item.instances[0].private_ip_address }}"
     wait: true
    loop: "{{ ec2_output.results }}" 
    when: action == "create"

  - name: create route 53 records
    amazon.aws.route53:
     state: present
     zone: "{{ domine_name }}"
     record: "Roboshop-{{ envmt }}.{{ domine_name }}"  #roboshop-dev.sivadevops707.online
     type: A
     ttl: 1
     value: "{{ item.instances[0].public_ip_address }}"
     wait: true
    loop: "{{ ec2_output.results }}" 
    when: 
    - item.item == "frontend"
    - action == "create"


